<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Three.js + AR.js Example</title>
	<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
	<script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>
	<script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
	<script src="./Surface.js"></script>
</head>

<body style="margin:0; overflow:hidden;">
	<div id="ar-container"></div>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			var scene = new THREE.Scene();
			var camera = new THREE.Camera();
			scene.add(camera);

			var light = new THREE.AmbientLight(0xffffff, 0.8);
			scene.add(light);
			var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
			directionalLight.position.set(1, 1, 1);
			scene.add(directionalLight);

			var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.getElementById('ar-container').appendChild(renderer.domElement);

			var arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
			function onResize() {
				arSource.onResizeElement();
				arSource.copyElementSizeTo(renderer.domElement);
				if (arContext.arController !== null) {
					arSource.copyElementSizeTo(arContext.arController.canvas);
				}
				// Принудительно обновляем размеры canvas
				renderer.setSize(window.innerWidth, window.innerHeight, false);
			}
			arSource.init(function onReady() {
				onResize();
			});
			window.addEventListener('resize', function () { onResize(); });
			window.addEventListener('orientationchange', function () { setTimeout(onResize, 500); });

			var arContext = new THREEx.ArToolkitContext({
				cameraParametersUrl: './data/camera_para.dat',
				detectionMode: 'mono'
			});
			arContext.init(function onCompleted() {
				camera.projectionMatrix.copy(arContext.getProjectionMatrix());
			});

			var markerRoot = new THREE.Group();
			scene.add(markerRoot);
			var markerControls = new THREEx.ArMarkerControls(arContext, markerRoot, {
				type: 'pattern',
				patternUrl: './data/VR_Study_Logo.patt',
			});

			var surface = new SurfaceThreeJS('MySurface', 1, 1, 50, 50);
			var mesh = surface.createMesh();
			mesh.rotation.x = -Math.PI / 6;
			markerRoot.add(mesh);

			function animate() {
				requestAnimationFrame(animate);
				if (arSource.ready) arContext.update(arSource.domElement);
				mesh.rotation.z += 0.05;
				renderer.render(scene, camera);
			}
			animate();
		});
	</script>
</body>

</html>